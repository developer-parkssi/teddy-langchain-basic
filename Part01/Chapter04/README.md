# LangChain 시작하기

## ChatOpenAI 주요 매개변수와 출력

- **temperature** 
  - 생성되는 텍스트의 창의성을 제어합니다. 값이 높을수록 더 창의적인 출력이 생성됩니다.
  - 0~2 사이의 값을 선택. 
    - 0.8~1과 같이 높은 값을 지정하면 출력을 더 무작위
    - 0.2와 같은 낮은 값은 출력을 더 집중되고 결정론적으로 만든다.
    - 문서 기반과 같이 정확한 답변을 요구할 때는 값을 0이나 0에 가깝게 설정
- **max_tokens**
  - 생성되는 출력의 최대 토큰 수를 지정합니다.
  - 값을 지정하지 않으면 모델에서 허용된 최대 토큰 수까지 허용
- **model_name**
  - 사용할 OpenAI 모델의 이름을 지정합니다.
  - 예: "gpt-3.5-turbo", "gpt-4" 등

### 주요 매개변수를 invoke() 함수로 응답하기

- invoke()를 실행하면 답변을 받기까지의 추가 정보도 표시
  - completion_tokens: 생성된 출력에 사용된 토큰 수
  - prompt_tokens: 프롬프트에 사용된 토큰 수
  - total_tokens: 프롬프트와 생성된 출력에 사용된 총 토큰

### logprob 활성화하기

- 주어진 GPT 모델의 토큰 확률 로그 값, 즉 모델이 토큰을 예측할 확률
- logprob는 확률 토큰 값에 자연 로그를 씌워서 변환한 값
- logprob 값이 0에 가까울수록 확률이 높고, 낮을 수록 음수로 나타난다

### stream() 함수로 스트리밍 출력하기

- ChatGPT로 질문을 입력하면 한번에 출력되는게 아니라 타자로 입력해서 나타내듯이 실시간으로 응답 텍스트 출력
- 이처럼 하나의 토큰 단위로 출력해주는 기능을 **스트리밍 출력**
- 반복문으로 출력하는 대신 `stream_response` 사용하면 간단하게 구현 가능

## 멀티 모달 모델로 이미지를 인식하여 답변 출력하기

- **멀티모달** 기능은 텍스트 뿐만 아니라 이미지, 음성 등 다양한 형태의 데이터를 입력이나 출력으로 처리하는 기술

### 시스템 프롬프트와 사용자 프롬프트 지정하기

- 시스템 프롬프트: AI가 특정한 방식으로 반응하도록 지침을 설저앟여 응답 스타일이나 목적, 제한 사항을 정의
  - 전역 설정이 적용되므로 모델의 역할을 나타내는 페르소나를 지정
- 사용자 프롬프트: AI에게 특정 질문이나 명령을 입력하는 것으로 AI에게 작업을 지시하는 역할
  - 재무제표 정리나 해석처럼 구체적인 작업을 쓰는 것이 좋다

## 프롬프트 템플릿 활용하기

- **프롬프트**: LLM에게 질문 및 지시 사항과 원하는 출력 답변의 형태를 지정하는 것
- **프롬프트 템플릿**: 프롬프트의 구조를 미리 정의해두고, 변수 부분만 동적으로 변경하여 사용할 수 있는 틀
    - 프롬프트 템플릿을 사용하면 일관된 형식으로 질문을 작성할 수 있어, 모델이 더 정확하고 일관된 답변을 제공
    - 반복적인 작업에 유용하며, 다양한 입력에 대해 동일한 형식의 출력을 얻을 수 있음

## LCEL로 체인 생성하기

- 템플릿에서 사용자가 입력 변수를 넣으면 프롬프트가 완성
- 이 프롬프트를 LLM으로 전달하여 답변을 생성하는 과정을 **체인(chain)** 이라고 함
- LCEL(LangChain Expression Language): 여러 구성 요소를 하나의 체인으로 엮어 주는 표현
  ```
  chain = prompt | model | output_parser
  ```
- 각 요소 사이에는 **파이프 연산자(|)** 를 입력해 구분

**invoke() 함수로 출력하기**

- invoke() 함수는 호출 시 python dictionary(키: 값)로 입력값 전달

## 출력 파서를 체인에 연결하기

- `StringOutputParser`는 LLM이 생성한 출력 결과를 필요에 맞게 가공하고 구조화하는 단계
- 출력 텍스트를 분석하여 특정 데이터 혹은 패턴을 추출하거나 사용자의 의도에 맞게 답변을 다듬는 역할

### 출력 파서를 이용해 문자열로 답변 출력하기

### 프롬프트 템플릿 변경해서 적용하기

- 프롬프트 템플릿을 변경해서 출력 파서에 연결

## batch() 함수로 일괄 처리하기

- Runnable은 LangChain에서 프롬프트 템플릿, LLM 호출기, 출력 파서 등 다양한 컴포넌트를 연결하고 실행하는 방식을 표준화한 공통 인터페이스
- 여기서 컴포넌트란 프롬프트 템플릿, llm, 출력 파서 등 체인을 구성하는 기능 단위
- **Runnable 프로토콜**을 사용하면 사용자 정의 체인을 쉽게 만들 수 있다
- Runnable 프로토콜은 대부분 컴포넌트에 구현되어 있으며, 표준화된 인터페이스를 제공해 사용자의 요구에 맞게 체인 호출 가능
  - stream(): 응답의 청크를 스트리밍
  - invoke(): 입력에 대해 체인 호출
  - batch():
    - 여러 작업을 그룹으로 묶어서 일괄 처리
    - 여러 개의 딕셔너리로 이루어진 리스트를 인자로 받아 각 딕셔너리에서 특정 키 값으로 사용
- max_concurrency 키를 통해 동시에 처리할 수 있는 최대 작업 수를 설정

## 비동기 호출 방법

- 동기는 커피를 주문하고 커피가 나올 때까지 아무것도 하지 않은채 기다리는 방식
- 비동기는 커피를 주문해놓고 커피가 나올 때까지 책을 읽거나 친구와 이야기를 나누다가 완료 알림받고 찾으러 가는 방식
- 비동기 메서드의 가장 큰 장점은 시스템 자원을 효율적으로 활용 가능
- 응답을 기다리는 동안에도 다른 작업을 처리 할 수 있어 전체적인 처리량이 늘어나고 응답 시간도 단축

### async stream: 비동기 스트림

- **astream()** 함수는 비동기 스트림을 생성하여 특정 주제의 메시지를 비동기적으로 처리
- `print()` 함수의 경우 출력할 내용이 먼저 이 버퍼에 저장되고, 특정 조건이 충족되면 한꺼번에 화면에 출력
  1. 버퍼가 가득찼을 때
  2. 줄바꿈이 발생했을 때

### async invoke: 비동기 호출

- **ainvoke()** 함수는 비동기 호출을 수행하여 특정 작업을 비동기적으로 처리

### async batch: 비동기 배치

- **abatch()** 함수는 비동기 배치를 수행하여 여러 작업을 비동기적으로 일괄 처리

## Runnable로 병렬 체인 구성하기

- prompt, model, StringOutputParser는 모두 Runnable 프로토콜을 가지고 있다
- 이 요소들을 연결해 만든 chain 자체도 Runnable
- 여러 Runnable 체인을 병렬적으로 동시에 실행하는 것, **RunnableParallel**
- 여러개의 딕셔너리를 포함하는 리스트를 인자로 받아, 각 딕셔너리에 있는 키에 해당하는 값을 처리

## 값을 전달해 주는 RunnablePassthrough

- 프롬프트의 변수를 입력할 때는 기본적으로 키-값 쌍의 딕셔너리 형식 사용
- RunnablePassthrough: 입력값을 그대로 다음 단계로 전달하는 역할
- 프롬프트의 변수 입력할 때 변수가 하나일 때는 값만 입력하는 것도 가능하지만, 일관성 위해 키, 값 모두 명시하는 것이 좋다
- 하지만 딕셔너리 형식 대신 단순히 숫자만 입력하고 싶을 때가 있다
- `RunnablePassthrough.assign()`은 기존 입력 딕셔너리의 데이터를 수정하거나 확장하는데 유용
- 해당 메소드를 사용하면 입력 값을 그대로 유지하면서도 추가로 값을 계산하거나 변형된 데이터 결합 가능

## 병렬로 Runnable을 실행하는 RunnableParallel

- **RunnableParallel**은 여러 Runnable 객체를 병렬로 실행
- 키-값 구조로 여러 개의 Runnable을 설정하고, 최종적으로 각 키 값을 결과로 반환

## 함수를 실행하는 RunnableLambda와 itemgetter

- **RunnableLambda**: 
  - 사용자가 정의한 함수를 매핑하여 프롬프트를 입력하기 전에 실행하고, 그 결과를 프롬프트에 전달하는 Runnable 객체
  - 이를 통해 python 로직이나 API 호출 등을 함수로 감싸서 먼저 실행하고 프롬프트 입력으로 활용 가능
- **itemgetter**:
  - 딕셔너리에서 특정 키에 해당하는 값을 출력



